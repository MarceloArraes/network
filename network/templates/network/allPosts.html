{% extends "network/layout.html" %}

{% block body %}
<div id="edit"></div>
<div id="initial"></div>

{% if user.is_authenticated %}
<div id="compose"></div>
{% endif %}

Post list by timestamp
<div id="timeline"></div>


<script type="text/babel">
  let user = document.getElementById('userr').innerHTML

  class Timeline extends React.Component {
    constructor(props) {
      super(props)
      this.state = {
        userposts: [],
      };
    }
    state = {
      mssg: ""
    };

    likePost = (event) => {
      console.log("liked the post")
      console.log(event.target.value)
      //Send like to backend. Try to update visible likes.
      fetch('/likes', {
        method: 'POST',
        body: JSON.stringify({
          post: event.target.value,
        })

      })
        .then(response => response.json())
        .then(result => {
          console.log(result)
          this.listposts()
        })
    }

    savePostContent = (event) => {
      const idnumber = event.target.id
      const newContent = event.target.value

      fetch('/editpost', {
        method: 'POST',
        body: JSON.stringify({
          post_id: idnumber,
          content: newContent,
        })
      })
        .then(response => response.json())
        .then(result => {
          console.log(result)
          console.log(result[0].user_id)
          this.listposts()
        })
    }

    goToProfile = (event) => {
      console.log(event.target.value)

      window.location.replace("profilePage/" + event.target.value);
      return;
    }

    editPost = (event) => {
      //Solution here is to change the state localy without going to the backend
      console.log('Edit Post')

      const userpostsLen = (this.state.userposts.length)
      // A mathematical solution to the problem of the inverted array (because of timeline order)
      const realplace = userpostsLen - event.target.value
      const userpostsCopy = this.state.userposts.slice()

      //find the exact post to momentanly change it. 
      userpostsCopy[realplace].editMode = true
      //this ignites a post re-render
      this.setState({ userposts: userpostsCopy })

      //this used to alter the .editMode field on definitive terms. Its not the right solution.
      /*       fetch('/editpost', {
              method: 'POST',
              body: JSON.stringify({
                post_id: idnumber,
              })
            })
              .then(response => response.json())
              .then(result => {
                console.log(result)
                console.log(result[0].user_id)
                this.listposts()
              }) */

    }

    contentUpdater = (event) => {
      console.log("Tracker funcionando")
      const userpostsLen = (this.state.userposts.length)
      // eu posso inverter o userposts ou posso sÃ³ acertar matematicamente.
      const realplace = userpostsLen - event.target.id

      console.log(this.state.userposts[realplace])

      const userpostsCopy = this.state.userposts.slice()
      userpostsCopy[realplace].content = event.target.value
      this.setState({ userposts: userpostsCopy })

    }

    render() {
      console.log(user)
      var editarea = document.createElement("TEXTAREA");
      return (
        this.state.userposts.map(post => (
          < div
            key={post.id}>
            <ul className="list-group-item list-group-item-action" >
              <button onClick={this.goToProfile} value={post.user_id}>See Profile: {post.user}</button>
              <p><div>
                {
                  post.user == user && post.editMode ?
                    (<div>
                      <input id={post.id} type="text" value={post.content} onChange={this.contentUpdater} />
                      <button id={post.id} value={post.content} onClick={this.savePostContent}>Save</button>
                    </div>) :
                    post.user == user ?
                      <div>{post.content}
                        <button onClick={this.editPost} value={post.id}>Edit</button>
                      </div> :
                      <div>{post.content}</div>
                }



              </div></p><p>{post.timestamp}</p><p>Likes: {post.likes}</p>
              <button onClick={this.likePost} value={post.id}>Like</button>
            </ul>
          </div >
        ))
      );
    }

    listposts = (event) => {
      let userposts = []
      // Fazer um fetch e chamar o show posts
      fetch('/showposts')
        .then(response => response.json())
        .then(data => {
          this.updateUserpost(data)
          console.log("List Posts")
          console.log(data)
        });
    }

    updateUserpost = (userpost) => {
      this.setState({ userposts: userpost })
    }

    componentDidMount() {
      return this.listposts()
    }
  }


  ReactDOM.render(<Timeline />, document.querySelector('#initial'));

</script>
{% endblock %}